â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ” DIAGNOSTIC: Ã‰COLE NE PEUT PAS ENVOYER MESSAGES      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Date: 11 Novembre 2025

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ PROBLÃˆME SIGNALÃ‰
===================

"cotÃ© ecole impossible d'envoyer des message"

ERREUR CONSOLE:
[2025-11-11T21:58:30.242Z] @firebase/firestore:
Firestore (11.9.1): WebChannelConnection RPC 'Listen' stream
0x39af1bf3 transport errored.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” ANALYSE DU CODE
==================

Fichier: lib/chat_page.dart
MÃ©thode: _sendMessage() (ligne 103)

FLUX D'ENVOI MESSAGE:
  1. Ligne 110: await _checkCanSendMessage()
  2. Si false â†’ return (pas d'envoi)
  3. Si true â†’ Envoi message (ligne 119)

VÃ‰RIFICATION Ã‰COLE (lignes 134-154):

Future<bool> _checkCanSendMessage() async {
  final currentUser = FirebaseAuth.instance.currentUser;
  if (currentUser == null) return false;

  // RÃ©cupÃ©rer les donnÃ©es de l'utilisateur
  final userData = await _firestoreService.getUser(currentUser.uid);
  if (userData == null) return false;

  // Si c'est une Ã©cole, vÃ©rifier qu'elle est vÃ©rifiÃ©e
  if (userData.accountType == 'school') {
    if (!userData.isVerified || userData.isVerificationExpired) {
      // Ã‰cole non vÃ©rifiÃ©e : afficher le dialogue d'abonnement
      if (mounted) {
        SubscriptionRequiredDialog.show(context, 'school');
      }
      return false;  â† BLOQUE ICI SI NON VÃ‰RIFIÃ‰E
    }
  }

  return true;
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ CAUSES POSSIBLES
===================

CAUSE 1: Ã‰cole non vÃ©rifiÃ©e
  Condition: !userData.isVerified
  RÃ©sultat: Dialogue abonnement affichÃ©, envoi bloquÃ©
  Fichier: UserModel (lib/models/user_model.dart:18)

CAUSE 2: VÃ©rification expirÃ©e
  Condition: userData.isVerificationExpired
  Calcul: DateTime.now().isAfter(verificationExpiresAt!)
  Fichier: UserModel (lib/models/user_model.dart:76-79)

CAUSE 3: Erreur WebChannel (erreur console)
  PossibilitÃ©s:
    - ProblÃ¨me connexion internet
    - RÃ¨gles Firestore bloquent
    - Index Firestore manquant
    - Quota Firebase dÃ©passÃ©

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” VÃ‰RIFICATION USERMODEL
==========================

Fichier: lib/models/user_model.dart

Champ isVerified (ligne 18):
  final bool isVerified;

Champ verificationExpiresAt:
  final DateTime? verificationExpiresAt;

Getter isVerificationExpired (lignes 76-79):
  bool get isVerificationExpired {
    if (verificationExpiresAt == null) return false;
    return DateTime.now().isAfter(verificationExpiresAt!);
  }

Getter hasAccess (lignes 85-86):
  bool get hasAccess =>
    (isVerified && !isVerificationExpired) || !isFreeQuotaExhausted;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” VÃ‰RIFICATION RÃˆGLES FIRESTORE
=================================

Collection: messages/{conversationId}/messages

RÃ¨gle CRÃ‰ATION (firestore.rules:104-107):

allow create: if isSignedIn()
  && exists(/databases/$(database)/documents/messages/$(conversationId))
  && isParticipant(get(...).data.participants)
  && request.resource.data.senderId == request.auth.uid;

CONDITIONS:
  1. âœ… isSignedIn() - Utilisateur authentifiÃ©
  2. âœ… exists(conversationId) - Conversation existe
  3. âœ… isParticipant() - Utilisateur dans participants
  4. âœ… senderId == auth.uid - Pas d'usurpation

âš ï¸ PAS DE VÃ‰RIFICATION isVerified dans les rÃ¨gles!
   â†’ Le blocage vient du CODE, pas de Firestore

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ DIAGNOSTIC: Ã‰COLE BLOQUÃ‰E
=============================

SCÃ‰NARIO 1: Ã‰cole pas vÃ©rifiÃ©e (isVerified = false)
  userData.isVerified = false
  â†’ Ligne 144: condition vraie
  â†’ Ligne 147: SubscriptionRequiredDialog affichÃ©
  â†’ Ligne 149: return false
  â†’ Message pas envoyÃ©

SCÃ‰NARIO 2: Ã‰cole vÃ©rifiÃ©e mais expirÃ©e
  userData.isVerified = true
  userData.verificationExpiresAt = date passÃ©e
  â†’ isVerificationExpired = true
  â†’ Ligne 144: condition vraie
  â†’ Dialogue abonnement affichÃ©
  â†’ Message pas envoyÃ©

SCÃ‰NARIO 3: Ã‰cole vÃ©rifiÃ©e et active
  userData.isVerified = true
  userData.verificationExpiresAt = date future (ou null)
  â†’ isVerificationExpired = false
  â†’ Ligne 144: condition fausse
  â†’ Ligne 153: return true
  â†’ Message envoyÃ© âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” ERREUR WEBCHANNEL
=====================

Erreur: WebChannelConnection RPC 'Listen' stream errored

SIGNIFICATION:
  - ProblÃ¨me connexion Firestore en temps rÃ©el
  - Stream snapshots() interrompu
  - Peut Ãªtre temporaire (rÃ©seau)

CAUSES POSSIBLES:
  1. Connexion internet instable
  2. RÃ¨gles Firestore deny la lecture
  3. Quota Firebase atteint
  4. Indexes manquants
  5. Timeout rÃ©seau

VÃ‰RIFIER:
  - Firebase Console â†’ Usage
  - Firebase Console â†’ Firestore â†’ Indexes
  - Connexion internet stable
  - Logs Firebase pour dÃ©tails erreur

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… ACTIONS Ã€ EFFECTUER
=======================

1. VÃ‰RIFIER STATUT Ã‰COLE DANS FIRESTORE
   Firebase Console â†’ Firestore â†’ users â†’ {schoolId}

   Champs Ã  vÃ©rifier:
   - accountType: "school"
   - isVerified: true/false â† CLEF
   - verificationExpiresAt: Timestamp â† CLEF

   Si isVerified = false:
     â†’ Ã‰cole pas vÃ©rifiÃ©e, messagerie bloquÃ©e (normal)

   Si verificationExpiresAt < maintenant:
     â†’ VÃ©rification expirÃ©e, messagerie bloquÃ©e (normal)

2. SI Ã‰COLE DOIT ÃŠTRE VÃ‰RIFIÃ‰E
   Option A: Mise Ã  jour manuelle Firestore
     - Ouvrir document users/{schoolId}
     - isVerified: true
     - verificationExpiresAt: date future (ex: +30 jours)

   Option B: SystÃ¨me d'abonnement
     - Ã‰cole paie abonnement
     - Cloud Function met Ã  jour isVerified

   Option C: Quota gratuit
     - VÃ©rifier freeQuotaUsed < freeQuotaLimit
     - hasAccess = true mÃªme sans vÃ©rification

3. VÃ‰RIFIER ERREUR WEBCHANNEL
   - Tester connexion internet
   - Recharger page/app
   - VÃ©rifier Firebase Console â†’ Usage
   - Regarder logs dÃ©taillÃ©s console

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ SOLUTION TEMPORAIRE (DÃ‰VELOPPEMENT)
=======================================

Si tu veux permettre Ã  l'Ã©cole d'envoyer messages SANS vÃ©rification
(SEULEMENT pour test/dÃ©veloppement):

Option 1: Commenter vÃ©rification (TEMPORAIRE)

Fichier: lib/chat_page.dart (lignes 142-151)

// Si c'est une Ã©cole, vÃ©rifier qu'elle est vÃ©rifiÃ©e
if (userData.accountType == 'school') {
  // TEMPORAIREMENT DÃ‰SACTIVÃ‰ POUR TESTS
  /*
  if (!userData.isVerified || userData.isVerificationExpired) {
    if (mounted) {
      SubscriptionRequiredDialog.show(context, 'school');
    }
    return false;
  }
  */
}

âš ï¸ NE PAS FAIRE EN PRODUCTION! Retirez aprÃ¨s tests.

Option 2: Utiliser hasAccess au lieu de isVerified

if (userData.accountType == 'school') {
  if (!userData.hasAccess) {  â† Utilise quota OU vÃ©rification
    if (mounted) {
      SubscriptionRequiredDialog.show(context, 'school');
    }
    return false;
  }
}

âœ… MIEUX: VÃ©rifie quota gratuit OU vÃ©rification

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š LOGIQUE MÃ‰TIER ACTUELLE
===========================

ENSEIGNANTS (teacher_transfer, teacher_candidate):
  âœ… Pas de vÃ©rification requise pour messagerie
  âœ… Peuvent toujours envoyer messages

Ã‰COLES (school):
  âš ï¸ VÃ©rification requise (isVerified = true)
  âš ï¸ VÃ©rification doit Ãªtre valide (pas expirÃ©e)
  âš ï¸ Sinon: Dialogue abonnement + blocage

RAISON:
  - Ã‰viter spam Ã©coles non vÃ©rifiÃ©es
  - MonÃ©tisation via abonnements Ã©coles
  - Garantir sÃ©rieux des Ã©coles

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ RECOMMANDATION
==================

1. VÃ‰RIFIER DANS FIREBASE CONSOLE:
   users/{schoolId}.isVerified
   users/{schoolId}.verificationExpiresAt

2. SI Ã‰COLE DOIT ACCÃ‰DER:
   Mettre Ã  jour manuellement:
     isVerified: true
     verificationExpiresAt: (date + 30 jours)

3. OU MODIFIER CODE:
   Utiliser hasAccess au lieu de isVerified
   â†’ Permet quota gratuit OU vÃ©rification

4. ERREUR WEBCHANNEL:
   - Probablement indÃ©pendant du blocage messagerie
   - VÃ©rifier connexion et Firebase Console
   - Peut Ãªtre temporaire

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¬ QUESTIONS Ã€ POSER
=====================

1. L'Ã©cole est-elle censÃ©e Ãªtre vÃ©rifiÃ©e/payÃ©e?
2. Quel est son statut dans Firestore (isVerified)?
3. Veut-on permettre quota gratuit pour Ã©coles?
4. L'erreur WebChannel persiste-t-elle aprÃ¨s rechargement?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
